---
resources:
  - name: lifecycle-repo
    type: git
    source:
      uri: https://github.com/buildpack/lifecycle.git
      branch: master

  - name: pack-repo
    type: git
    source:
      uri: https://github.com/buildpack/pack.git
      branch: master

  - name: pipeline-repo
    type: git
    source:
      uri: https://github.com/matthewmcnew/buildpack-pipeline.git
      branch: poc

  - name: packs-base-image
    type: docker-image
    source:
      repository: gcr.io:443/cf-build-service-dev-219913/packs-base # port needed for private repos
      username: _json_key
      password: ((concourse-service-account-key-json))

  - name: packs-run-image
    type: docker-image
    source:
      repository: gcr.io:443/cf-build-service-dev-219913/packs-run # port needed for private repos
      username: _json_key
      password: ((concourse-service-account-key-json))

  - name: packs-build-image
    type: docker-image
    source:
      repository: gcr.io:443/cf-build-service-dev-219913/packs-build # port needed for private repos
      username: _json_key
      password: ((concourse-service-account-key-json))

  - name: packs-samples-image
    type: docker-image
    source:
      repository: gcr.io:443/cf-build-service-dev-219913/packs-samples # port needed for private repos
      username: _json_key
      password: ((concourse-service-account-key-json))

  # keep a new line at the end of this file :)jobs:
  - name: lifecycle-unit
    plan:
      - get: lifecycle-repo
        trigger: true
        version: every
      - get: pipeline-repo
      - task: run-unit-tests
        privileged: true
        file: pipeline-repo/tasks/run-lifecycle-unit/task.yml
      - put: packs-base
        params:
          import_file: packs-build/built-lifecyle-images/base.tar
      - put: packs-run
        params:
          import_file: packs-build/built-lifecyle-images/run.tar
      - put: packs-build
        params:
          import_file: packs-build/built-lifecyle-images/build.tar
      - put: packs-samples
        params:
          import_file: packs-build/built-lifecyle-images/samples.tar

  - name: pack-unit
    plan:
      - get: pack-repo
        trigger: true
        version: every
      - get: pipeline-repo
      - task: run-unit-tests
        privileged: true
        file: pipeline-repo/tasks/run-pack-unit/task.yml

  - name: acceptance
    plan:
      - get: pack-repo
      - get: pipeline-repo
      - get: packs-samples
        passed: [lifecycle-unit]
      - task: acceptance
        privileged: true
        file: pipeline-repo/tasks/run-acceptance/task.yml
